https://www.toutiao.com/i7012862509967278605/?timestamp=1632930342&app=news_article_lite&use_new_style=1&req_id=202109292345410101351630782B0909B3&share_token=885a2f40-12ed-4cc8-9cfa-b7d2c8865460&group_id=7012862509967278605


# 1.CAP定理

**一致性**（Consistency）、**可用性**（Availability）、**分区容错性**（Partition tolerance）。分布式系统中，P是存在的，但是 一致性与可用性不能同时满足。
设计系统时采用BASE理论（基本可用、软状态、最终一致性），在大型分布式系统中通过牺牲强一致性，来获得可用性并允许数据在短时间内不一致，最终会达到一致状态。
例如：Zk 是CP模型、consul是CP模型、 Eureka是AP模型、Nacos是**CP(支持注册持久化实例)+AP(只支持注册临时实例)**模型

# 2.Zookeeper框架

ZooKeeper是一个分布式应用程序协调服务，解决了分布式一致性问题，是集群的管理者提供文件系统和通知机制，提供 配置维护、集群管理、命名服务、分布式同步等功能。用于dubbo、Kafka框架的注册中心。
同时通过临时顺序节点(最小节点)实现分布式锁。

- 四种节点：持久节点、持久顺序节点、临时节点、临时顺序节点(连接建立、断开删除)
- 文件系统：树状的目录结构，不能存放大量数据，每个节点数据上限1M
- watch机制：一个Watch事件是一个一次性的触发器，当被设置了 Watch 的数据发生了改变的时候，则服务器将这个改变发送给设置了 Watch 的客户端。注册watcher的方法：getData、exists、getChildren。


# 3.Zookeeper 工作原理

- Zookeeper 的核心是 原子广播 ，这个机制保证了 各个 Server 之间的同步 。实现这个机制的协议叫做 Zab 协议、paxos算法 。
  Zab 协议有两种模式，它们分别是 **恢复模式（选主）** 和 **广播模式（同步）** 。当服务启动或者在领导者崩溃后，Zab 就进入了恢复模式，当领导者被选举出来，且大多数 Server 完成了和 leader 的状态同步以后，恢复模式就结束了。
  状态同步保证了 leader 和 Server 具有相同的系统状态。

- 服务器状态：LOOKING 寻找Leader（进入选主模式）、FOLLOWING 跟随者状态、LEADING 领导者状态、OBSERVING 观察者状态。
- ![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806100750320-1903700679.png)
- 集群角色：leader、follower、observer(观察者，只读不写、不参与投票选举。扩展系统了，提高读速度)
- zk集群 至少需要一半机器上可用, 集群规则为2N+1台，N>0，即至少3台。主要是为了选举算法。
- java客户端：zk自带的zkclient及Apache开源的Curator。
- 基于文件系统支持KV数据存储，


# 4.Zookeeper 选举流程

- leader 功能： 减少重复计算,提高性能,其他机器共享结果。
- 集群启动、启动后leader挂了、集群中follower数量不足半数、集群中增加Follower  这四种情景都会进行选举。
- [选举流程参考](https://www.cnblogs.com/longxok/p/8951867.html)


# 5.Eureka 特点

- **剔除服务机制**：默认周期为30秒进行检查某个实例心跳。默认90秒会注销该实例。
- **自我保护机制**：15分钟内超过85%的节点没有正常心跳，则认为出现了网络故障，进行自我保护模式(不再从注册表中移除因为长时间没有收到心跳而过期的服务).
- 是个servlet程序，直接集成到应用中，依赖于应用自身完成服务的注册与发现
- 遵循AP（可用性+分离容忍）原则，有较强的可用性，服务注册快，但牺牲了必定的一致性。无管理界面
- 服务发现感知很差，一般等心跳 才能发现，分钟级别的事情。
- Eureka 2.x目前已停止维护，但是Eu、reka 1.x 仍然是比较活跃的
- 客户端定时器：每隔30秒心跳、每隔30秒缓存刷新，多个定时器协同按需注册（本地服务地址时触发拉取、定时拉取、服务下线）

![](https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240517140313241-665989300.png)

![](https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240517140355515-1267487491.png)


# 5.1 Eureka 集群数据同步方式

- 主从复制 Master-Slave 模式: 主写从对
- 对等复制 Peer to Peer 模式: 各个服务都可以读写
- Eureka集群 采用Peer to Peer 模式。
- Eureka 通过 http header就是 HEADER_REPLICATION 解决循环复制问题。
- Eureka 通过 lastDirtyTimestamp 解决复制冲突。
- Eureka 通过心跳机制实现数据修复。

# 如何实现服务发版流程不中断，优雅停机。

- 1.客户端短轮询方式,加长延迟停机时间，保证服务端先下线。
  - 客服端每30秒（eureka.client.registryFetchIntervalSeconds 配置项）从服务端拉去最新服务实例列表缓存。
  - 当服务端有实例下线时，服务端先向Eureka注册中心发送下线通知，服务端实例继续停止运行，待超过30秒后，在进行服务下线。
  - 可以保障客户端缓存里的服务地址不会失效，从而保障微服务的高可用。
  - 通过配置缩短心跳间隔(`eureka.instance.heartbeatIntervalInMilliseconds`)、缓存刷新间隔(`eureka.client.registryFetchIntervalSecond`)定时器提高服务发现的及时性。

- 2.客户端长轮询(long polling)方式,近实时从注册中心感知服务端下线。

- 3.应用端基于Ribbon调用对应的错误机制(链接超时、拒绝、404等错误),实现服务链表重试。

- 4.短轮询方式，结合Ribbon使用，Ribbon.ServerListRefreshInterval 设置客户端服务列表刷新间隔。

- 5.选用类似监听机制的注册中心，近实时感知服务端下线，如 Nacos

# 6.Consul 特点

- 遵循CP原则（一致性+分离容忍） 服务注册稍慢，因为其一致性致使了在Leader挂掉时从新选举期间consul不可用。 类似 Zookeeper。
- go语言开发。独立外部应用 侵入性小。
- 也可以实现K/V数据存储， 虽然也支持配置中心，但更侧重于注册中心。。
- 也可以作为配置中心，不能自动更新。 要依赖 Consul-template 可实现动态配置 。consul作为配置中心，有一个点需要注意，通过@Value注入的属性，修改consul的配置后，属性不能立即生效，需要服务重启。而通过@ConfigurationProperties注入的属性，修改consul的配置后，属性会立即生效，所以建议如果需要动态生效的配置，最好使使用@ConfigurationProperties进行属性的注入。
- 使用raft算法实现选举，使用Gossip维护节点的元数据信息，进行信息交换。只有Leader可写，读可以是任意节点。
- Consul 默认情况下不自动注销实例，但可以通过配置健康检查（Health Checks）来实现自动注销。

```
可以设置 health-check-critical-timeout 参数来控制服务实例在标记为“critical”状态后多久自动注销。例如，以下配置表示如果服务在30秒内未响应健康检查，Consul 将自动注销服务：
service {
  name = "my-service"
  check {
    id      = "my-service-liveness"
    name    = "Service is alive"
    script  = "curl -s http://localhost:8080/health || exit 1"
    interval = "10s"
    timeout = "5s"
  }
  deregister_critical_service_after = "30s"  # 自动注销服务的超时时间
}

```


# 7.Nacos 特点

- 遵循CP原则（一致性+分离容忍） 和AP原则（可用性+分离容忍）。AP 是通过 Nacos 自研的 Distro 协议来保证的，CP 是通过 Nacos 的 Raft 协议来保证的。

- 支持注册中心(推荐AP)+ 配置中心(推荐CP)，默认采用AP模型，可以手动设置成CP模型。

- Nacos可用根据业务和环境进行分组管理，提供服务标签数据，支持对服务在线管理。

- 有对应的后台管理页面，提供一些服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及最首要的 metrics 统计数据。

- Nacos 2.x 使用 GRPC 作为通信协议代替HTTP协议，支持长连接。

  - 心跳监测：

    >在Nacos 2.x版本以后,使用Grpc协议代替了http协议，长连接会保持客户端和服务端发送的状态。临时实例走的是distro协议，持久实例则走的是Raft协议存储。主要有两种检测机制：
    >1)、客户端主动上报机制(临时实例)：主动每5s向Nacos服务端发送心跳。
    >2)、服务器端主动下探机制(持久实例)：Nacos服务端主动向每个Nacos客户端发起探活。
    >NacosServer每3秒检测所有超过20S内没有发生过通讯的客户端，向客户端发起探测请求，如果客户端在指定时间内成功响应，则检测通过，否则执行下线。

  - 服务发现 (实时感知)：

    > 客户端订阅相关服务,向 Nacos 服务器发送订阅请求。
    > Nacos服务器接收到订阅请求后，会将订阅信息存储，并开始监听服务实例的变化。
    > 若服务实例有更新（如新增、下线、健康状态改变等），Nacos 服务器会主动将这些变更推送给订阅了相关服务的客户端。

![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806153311379-771263869.png)
!(https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240524163557355-1045013368.png)


# 8.各注册中心的比较


!(https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806143011032-1072459649.png)

![](https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240517105702851-843054666.png)

|                    | Zookeeper       | Eureka                                                       | Consul                       | Nacos2.x                                            | Etcd           |
| ------------------ | --------------- | ------------------------------------------------------------ | ---------------------------- | --------------------------------------------------- | -------------- |
| 数据一致性         | CP              | AP                                                           | CP                           | AP(注册中心) / CP(配置中心)                         | CP             |
| 一致性协议         | Paxos           | --                                                           | Raft                         | -- / Raft                                           | Raft           |
| 健康检查           | Keep Alive      | ClientBeat                                                   | TCP/HTTP/grpc/Cmd            | TCP/HTTP/MySql/ClientBeat                           | ClientBeat     |
| Watch机制          | 有              | long polling                                                 | long polling                 | 有(发布、订阅)                                      | long polling   |
| 自动注销实例       |                 | √                                                            | × (默认无，需相关配置)       | √                                                   |                |
| 访问协议           | TCP             | HTTP                                                         | HTTP/DNS                     | HTTP/DNS/gRpc                                       | HTTP           |
| 多数据中心         | ×               | √                                                            | √                            | √                                                   |                |
| 跨注册中心同步     | ×               | ×                                                            | √                            | 基于三方工具NacosSync 同步                          |                |
| Spring Cloud集成   | √               | √                                                            | √                            | √                                                   |                |
| Dubbo集成          | √               | ×                                                            | ×                            | √                                                   |                |
| K8s集成            | ×               | ×                                                            | √                            | √                                                   | √              |
| 部署难度           | 4               | 1                                                            | 3                            | 2                                                   | 4              |
| 开发语言           | Java            | Java                                                         | Go                           | Java                                                | Go             |
| 功能               | 分布式数据协同  | 基于 HTTP 协议的服务发现                                     | 多种机制的服务发现和 KV 存储 | 多种机制的服务发现、KV 存储、配置中心、大而全的功能 | 分布式数据协同 |
| 异常服务下线时效性 | Watch机制，秒级 | 取决于具体配置。默认 30s 更新服务实例信息，90s 才会去剔除失效的节点，在这种配置下可能 2 分钟才能获取到最新的配置 | 看具体配置                   | 发布/订阅，秒级                                     |                |


# 9.设计注册中心要考虑哪些

- 服务自动注册与发现。服务端启动后自动注册，客户端拉取方式（轮询、长轮询，还是长连接双向通讯）。
  - 长连接: 一般使用WebSocket、gRPC(基于HTTP/2协议和Protocol Buffers设计)双向通信协议，需要更多的服务器和客户端支持，还可能存在防火墙等兼容问题。增加服务器资源销毁。
  - 长轮询: 基于HTTP/1.1，广泛支持，兼容性较好,另外实现简单，链接中断恢复简单。可以适当减少服务器资源占用。
  - 推模式：客户端与服务端建立好网络长连接,直接通过长连接通道推送到客户端.
    - 优点：数据变更后，服务端实时推送，客户端实现简单。
    - 缺点：客户端的数量比较多，服务端需要耗费大量的内存资源来保存每个资源，并且为了检测连接的有效性，还需要心跳机制来维持每个连接的状态。另外客户端会存在积压问题。
  - 拉模式：客户端主动向服务端发出请求，拉取相关数据
    - 优点：客户端发起请求，故不存在推模式中数据积压的问题
    - 缺点：数据不够及时，如果服务端配置长时间不更新的情况下，客户端的定时任务会做一些无效的Pull操作。

- 健康检查：心跳检测续约,自动下线。维持 注册中心与服务端心跳检测，自动续约或者下线机制。
- CAP设计原则的选择，BASE 理论 。考虑CP 模式 还是AP模式？也可以仿照 Nacos 的CP+AP模式
- 访问协议 HTTP、DNS、TCP、gRPC？
- 当服务查询量很大的时候，怎么考虑性能。如：消费端缓存本地路由，提高路有效率和容错。在注册中心不可用时，消费者依然根据本地路由实现服务可靠调用
- 支持集群，数据同步
- 还要考虑消费者如何及时获取生产者变更问题
  - 1.发布-订阅模式，采用监听器或者回调机制。 参考 Zookeeper 的 watcher机制
  - 2.主动拉去策略，采用定时拉去最新服务列表更新本地缓存，例如 Eureka

- 考虑负载均衡问题：服务端的负载均衡(典型代表 Nginx)、客服端的负载均衡(Ribbon)。提供些常见的负载均衡算法:轮询(加权)法、随机(加权)法、哈希算法、最小连接数法等
- 如何支持多数据中心、考虑开发语言的技术栈,应用层面的使用
- 当服务查询量很大的时候，怎么考虑性能
- 后台监控管理页面，可以对服务在线管理。

![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806151736616-167930123.png)



- [大神分析](https://www.cnblogs.com/wtzbk/p/14071040.html) ：https://www.cnblogs.com/wtzbk/p/14071040.html

# 10.配置中心选择与比较

- Nacos 与 Apollo 配置中心所有功能差不多，Nacos还支持注册中心更强大，Nacos良好的UI管理后台，有很多相关中文文档。
- Consul也支持配置中心、配置UI页面功能简陋、无权限管理
- Zookeeper也支持存储数据，不过功能简陋，无UI界面、无权限管理、不好用

| 对比项目                 | Apollo                             | Nacos                      |
| ------------------------ | ---------------------------------- | -------------------------- |
| 开源时间                 | 2016.5                             | 2018.6                     |
| 配置实时推送             | 支持（HTTP长轮询1s内）             | 支持（HTTP长轮询1s内）     |
| 版本管理                 | 自动管理                           | 自动管理                   |
| 配置回滚                 | 支持                               | 支持                       |
| 权限管理                 | 支持（细粒度）                     | 粗粒度,无审核机制          |
| 灰度发布                 | 支持                               | 支持                       |
| 多集群多环境             | 支持                               | 支持                       |
| 监听查询                 | 支持                               | 支持                       |
| 多语言                   | Go,C++,Python,Java,.net,OpenAPI    | Python,Java,Nodejs,OpenAPI |
| 分布式高可用最小集群数量 | Config*2+Admin*3+Portal/*2+Mysql=8 | Nacos/*3+MySql=4           |
| 配置格式校验             | 支持                               | 支持                       |
| 通信协议                 | HTTP                               | HTTP                       |
| 单机读（tps）            | 9000                               | 15000                      |
| 单机写（tps）            | 1100                               | 1800                       |

### 结论

- 性能方面Nacos的读写性能最高，Apollo次之；
- 功能方面Apollo最为完善，但Nacos具有Apollo大部分配置管理功能。Nacos的一大优势是整合了注册中心、配置中心功能，部署和操作相比 Apollo都要直观简单，并减轻运维及部署工作。
- Apollo和Nacos生态支持都很广泛，在配置管理流程上做的都很好。Apollo在配置管理做的更加全面；Nacos则使用起来比较简洁，在对性能要求比较高的大规模场景更适合。
- 对于公司目前来说，修改配置的次数不是特别的频繁，对于配置权限的管理不是特别严格的，且对读写性能有一定要求的，可采用Nacos，反之使用Apollo。



# 11.设计一个高性能的配置中心

- 考虑可用性与易用性：**对业务代码入侵小、统一配置管理UI页面**、支持集群高可用、多数据中心。
- 功能特性：**支持灰度发布、配置修改实时生效、用户角色权限、增加审核权限、操作审计、支持多tag环境、支持动态配置、告警通知、一键回滚、版本发布管理、本地缓存**
- 技术兼容性：兼容现有技术体系、支持springboot与springcloud生态
- 扩展性：提供开发平台API、提供各语言客服端。

# 12.常用链路追踪比较
- Skywalking方法级（展示的更详细），已加入Apache孵化器。方法中所有的调用都展示出来了，如数据库调用、redis调用，第三方网络调用，支持 **OpenTracing**（分布式系统追踪的协议规范）。 **代码无侵入**，开箱即用。使用字节码增强技术。UI界面国产开源，更适合国人眼球。支持TraceId查询，JVM监控。
- CAT 早起美团开发的链路追踪，代码需埋点，侵入较高。
- Zipkin：简单、轻量级，只能展示接口级。有一定的代码侵入性。
- Pinpoint **代码无侵入**收集的数据粒度非常细，UI功能强大，**但性能损耗大**，因其出现的时间较长，完成度也很高，应用的公司较多。

![](https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240517153157239-1472669508.png)