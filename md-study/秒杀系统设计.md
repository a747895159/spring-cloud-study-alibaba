# 1.秒杀系统设计考虑因素

- **架构上思考秒杀是个三高系统(高性能、高一致、高可用)**
- **数据要尽量少、请求数要尽量少、后台服务路径要短、依赖要尽量减少、不要有单点。**

	![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210807161121595-619317594.png)

- 高性能：
	- **动静分离**：
		- 将静态数据html、JS、图片等信息缓存在CDN。
		- 同时用户请求后，再将静态数据信息缓存至用户浏览器。
		- 将商品信息数据缓存在WEB端，每次加载商品直接缓存读取。
		
	- **热点优化**：
		- 热点操作：用户行为、不好改变，可以对用户请求IP或账号频繁请求限流
		- 热点隔离：将秒杀系统环境独立部署、单独的集群。
		- 热点识别：对热点数据限流或缓存。

	- **系统优化**：
		- 减少请求次数；
		- 优化无必要的日志打印；
		- 优化返回数据结构内容;
		- 框架组件优化(去掉一些没必要的过滤器)
	
- 一致性(预占扣减)：
	- 避免超卖：
		- 设置库存字段为无符号整数,一旦库存为负直接报错。
		- CASE WHEN 判断，返回执行结果。
			```
				UPDATE item SET inventory = CASE WHEN inventory >= xxx THEN inventory-xxx ELSE inventory END
			```
	- 性能优化：
		- 高并发读：
			- 分层校验(秒杀资格、商品状态、答题校验、请求限流等),
			- 采用分布式缓存或本地缓存、允许一定数据脏读（比如库存数量）。数据写时再校验。
		- 高并发写：
			- 应用层排队：分布式锁，控制单商品同一行记录操作的并发度。
			- 数据层排队：定制数据优化，
			```
				阿里的数据库团队开发了针对InnoDB 层上的补丁程序（patch），可以基于DB层对单行记录做并发排队，从而实现秒杀场景下的定制优化——注意，排队和锁竞争是有区别的，如果熟悉 MySQL 的话，就会知道 InnoDB 内部的死锁检测，以及 MySQL Server 和 InnoDB 的切换都是比较消耗性能的。实现事务不需要等待实时提交，而是在数据执行完最后一条 SQL 后，直接根据 TARGET_AFFECT_ROW的结果进行提交或回滚，减少网络等待的时间（毫秒级）。
			```

- 高可用：
	- **流量削峰**：
		- **增加答题:延缓瞬时请求数**
		- **MQ消息队列排队(增加当前时间)**
		
	- **分层过滤**：
			- 队列消费：对写数据进行基于时间的合理分片(在一定时间内未处理的直接过滤)，过滤掉过期的失效请求。
			- 读限流：对读请求做限流保护，将超出系统承载能力的请求过滤掉。
			- 读缓存：对读请求做数据缓存，将重复的请求过滤掉。
			- 写限流：对写请求做限流保护，将超出系统承载能力的请求过滤掉。
			- 写校验：对写请求做一致性校验，只保留最终的有效数据 。

- **兜底设计**：
	
	- 架构阶段: 考虑系统可扩展性与容错性，避免单点问题，多地单元化部署.
	- 编码阶段：保证代码健壮性、合理超时退出机制、避免拖垮。
	- 测试阶段：全链路压测、摸排各环节性能指标
	- 日常运维：线上降级、限流、熔断保护。详细了解各业务环境瓶颈：什么业务可以降级、限流频次等。
	

- 举例一：
	- 1.用户下单请求进来，通过各种限流校验后，生成T+3s de 时间戳作为标识，返给用户。前端延迟3s轮询结果。 同时将 用户id作为key、商品数量信息作为value, 放进redis中。设置有效期1min.
	
	- 1.库存总数据放到redis中，MQ消峰后：
	    - 对消息做时间片3s过滤，超过3s，直接失效。同时删除 第一步请求标识的缓存。
		- 将用户 id、下单请求标识号、
		- 通过Redis lua脚本 实现redis库存扣减。
		- 扣减商品库存、生成用户订单，发送延迟10分钟MQ消息。
		- 如果上一步超时或 异常 都删除。否则将缓存中请求标识更新为已抢到
	- 2.库存返还：
		- 用户取消订单、或者下单延迟消息未支付、
		- 加DB中商品库存数。
		- 修改redis中商品库存数。
	- 对应取消订单或者延迟支付订单、基本已过了秒杀高峰期，加库存没有那么多限制了。


![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210807161246137-1756428394.png) 

> [**参考链接** :](https://blog.csdn.net/l18848956739/article/details/106639469)  https://blog.csdn.net/l18848956739/article/details/106639469 、https://note.youdao.com/s/Lym0njvX




# 2.秒杀预占后,订单未支付，如何返还？









