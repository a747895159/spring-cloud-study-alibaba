

https://www.toutiao.com/i7012862509967278605/?timestamp=1632930342&app=news_article_lite&use_new_style=1&req_id=202109292345410101351630782B0909B3&share_token=885a2f40-12ed-4cc8-9cfa-b7d2c8865460&group_id=7012862509967278605


# 1.CAP定理

**一致性**（Consistency）、**可用性**（Availability）、**分区容错性**（Partition tolerance）。分布式系统中，P是存在的，但是 一致性与可用性不能同时满足。
设计系统时采用BASE理论（基本可用、软状态、最终一致性），在大型分布式系统中通过牺牲强一致性，来获得可用性并允许数据在短时间内不一致，最终会达到一致状态。
例如：Zk 是CP模型、consul是CP模型、 Eureka是AP模型、Nacos是**CP(支持注册持久化实例)+AP(只支持注册临时实例)**模型

# 2.Zookeeper框架

ZooKeeper是一个分布式应用程序协调服务，解决了分布式一致性问题，是集群的管理者提供文件系统和通知机制，提供 配置维护、集群管理、命名服务、分布式同步等功能。用于dubbo、Kafka框架的注册中心。
同时通过临时顺序节点(最小节点)实现分布式锁。
- 四种节点：持久节点、持久顺序节点、临时节点、临时顺序节点(连接建立、断开删除)
- 文件系统：树状的目录结构，不能存放大量数据，每个节点数据上限1M
- watch机制：一个Watch事件是一个一次性的触发器，当被设置了 Watch 的数据发生了改变的时候，则服务器将这个改变发送给设置了 Watch 的客户端。注册watcher的方法：getData、exists、getChildren。


# 3.Zookeeper 工作原理

- Zookeeper 的核心是 原子广播 ，这个机制保证了 各个 Server 之间的同步 。实现这个机制的协议叫做 Zab 协议、paxos算法 。
Zab 协议有两种模式，它们分别是 **恢复模式（选主）** 和 **广播模式（同步）** 。当服务启动或者在领导者崩溃后，Zab 就进入了恢复模式，当领导者被选举出来，且大多数 Server 完成了和 leader 的状态同步以后，恢复模式就结束了。
状态同步保证了 leader 和 Server 具有相同的系统状态。

- 服务器状态：LOOKING 寻找Leader（进入选主模式）、FOLLOWING 跟随者状态、LEADING 领导者状态、OBSERVING 观察者状态。
- ![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806100750320-1903700679.png)
- 集群角色：leader、follower、observer(观察者，只读不写、不参与投票选举。扩展系统了，提高读速度)
- zk集群 至少需要一半机器上可用, 集群规则为2N+1台，N>0，即至少3台。主要是为了选举算法。
- java客户端：zk自带的zkclient及Apache开源的Curator。
- 基于文件系统支持KV数据存储，


# 4.Zookeeper 选举流程
- leader 功能： 减少重复计算,提高性能,其他机器共享结果。
- 集群启动、启动后leader挂了、集群中follower数量不足半数、集群中增加Follower  这四种情景都会进行选举。
- [选举流程参考](https://www.cnblogs.com/longxok/p/8951867.html)


# 5.Eureka 特点

- **剔除服务机制**：默认周期为30秒进行检查某个实例心跳。默认90秒会注销该实例。
- **自我保护机制**：15分钟内超过85%的节点没有正常心跳，则认为出现了网络故障，进行自我保护模式(不再从注册表中移除因为长时间没有收到心跳而过期的服务).
- 是个servlet程序，直接集成到应用中，依赖于应用自身完成服务的注册与发现
- 遵循AP（可用性+分离容忍）原则，有较强的可用性，服务注册快，但牺牲了必定的一致性。无管理界面
- 服务发现感知很差，一般等心跳 才能发现，分钟级别的事情。
- Eureka 2.x目前已停止维护，但是Eu、reka 1.x 仍然是比较活跃的
- 客户端定时器：每隔30秒心跳、每隔30秒缓存刷新，多个定时器协同按需注册（本地服务地址时触发拉取、定时拉取、服务下线）

![](https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240517140313241-665989300.png)

![](https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240517140355515-1267487491.png)


# 5.1 Eureka 集群数据同步方式
- 主从复制 Master-Slave 模式: 主写从对
- 对等复制 Peer to Peer 模式: 各个服务都可以读写
- Eureka集群 采用Peer to Peer 模式。
- Eureka 通过 http header就是 HEADER_REPLICATION 解决循环复制问题。
- Eureka 通过 lastDirtyTimestamp 解决复制冲突。
- Eureka 通过心跳机制实现数据修复。

# 5.2 Eureka 没有实现Watch机制，如何实现服务发版流程不中断，优雅停机。
- 客服端每30秒（eureka.client.registryFetchIntervalSeconds 配置项）从服务端拉去最新服务实例列表缓存。
- 当服务端有实例下线时，服务端先向Eureka注册中心发送下线通知，服务端实例继续停止运行，待超过30秒后，在进行服务下线。
- 可以保障客户端缓存里的服务地址不会失效，从而保障微服务的高可用。
- 通过配置缩短心跳间隔(`eureka.instance.heartbeatIntervalInMilliseconds`)、缓存刷新间隔(`eureka.client.registryFetchIntervalSecond`)定时器提高服务发现的及时性。


# 6.Consul 特点

- 遵循CP原则（一致性+分离容忍） 服务注册稍慢，因为其一致性致使了在Leader挂掉时从新选举期间consul不可用。 类似 Zookeeper。
- go语言开发。独立外部应用 侵入性小。
- 也可以实现K/V数据存储
- 也可以作为配置中心，不能自动更新。 要依赖 Consul-template 可实现动态配置 。consul作为配置中心，有一个点需要注意，通过@Value注入的属性，修改consul的配置后，属性不能立即生效，需要服务重启。而通过@ConfigurationProperties注入的属性，修改consul的配置后，属性会立即生效，所以建议如果需要动态生效的配置，最好使使用@ConfigurationProperties进行属性的注入。


# 7.Nacos 特点

- 遵循CP原则（一致性+分离容忍） 和AP原则（可用性+分离容忍）。AP 是通过 Nacos 自研的 Distro 协议来保证的，CP 是通过 Nacos 的 JRaft 协议来保证的。
- 支持注册中心+ 配置中心
- Nacos可用根据业务和环境进行分组管理，提供服务标签数据，支持对服务在线管理
- 有对应的后台管理页面，提供一些服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及最首要的 metrics 统计数据
- Nacos 与Consul 具有相似功能，Consul 虽然也支持配置中心，但更侧重于注册中心

![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806153311379-771263869.png)

# 8.各注册中心的比较


- ![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806143011032-1072459649.png)

- ![](https://img2024.cnblogs.com/blog/1694759/202405/1694759-20240517105702851-843054666.png)




# 9.设计注册中心要考虑哪些

- 服务自动注册与发现。服务端启动后自动注册，客户端主动拉去。
- 健康检查：心跳检测续约,自动下线。维持 注册中心与服务端心跳检测，自动续约或者下线机制。
- CAP设计原则的选择，BASE 理论 。考虑CP 模式 还是AP模式？也可以仿照 Nacos 的CP+AP模式
- 访问协议 HTTP、DNS、TCP？
- 当服务查询量很大的时候，怎么考虑性能。如：消费端缓存本地路由，提高路有效率和容错。在注册中心不可用时，消费者依然根据本地路由实现服务可靠调用
- 支持集群，数据同步
- 还要考虑消费者如何及时获取生产者变更问题
	- 1.发布-订阅模式，采用监听器或者回调机制。 参考 Zookeeper 的 watcher机制
	- 2.主动拉去策略，采用定时拉去最新服务列表更新本地缓存，例如 Eureka

- 考虑负载均衡问题：服务端的负载均衡(典型代表 Nginx)、客服端的负载均衡(Ribbon)。提供些常见的负载均衡算法:轮询(加权)法、随机(加权)法、哈希算法、最小连接数法等
- 如何支持多数据中心、考虑开发语言的技术栈,应用层面的使用
- 当服务查询量很大的时候，怎么考虑性能
- 后台监控管理页面，可以对服务在线管理。

![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210806151736616-167930123.png)



- [大神分析](https://www.cnblogs.com/wtzbk/p/14071040.html) ：https://www.cnblogs.com/wtzbk/p/14071040.html

# 10.配置中心选择与比较

- Nacos 与 Apollo 配置中心所有功能差不多，Nacos还支持注册中心更强大
- Consul也支持配置中心、配置UI页面功能简陋、无权限管理
- Zookeeper也支持存储数据，不过功能简陋，无UI界面、无权限管理、不好用

![](https://img2020.cnblogs.com/blog/1694759/202108/1694759-20210807093725894-1573926131.png)



# 11.设计一个高性能的配置中心

- 考虑可用性与易用性：**对业务代码入侵小、统一配置管理UI页面**、支持集群高可用、多数据中心。
- 功能特性：**支持灰度发布、配置修改实时生效、用户角色权限、增加审核权限、操作审计、支持多tag环境、支持动态配置、告警通知、一键回滚、版本发布管理、本地缓存**
- 技术兼容性：兼容现有技术体系、支持springboot与springcloud生态
- 扩展性：提供开发平台API、提供各语言客服端















